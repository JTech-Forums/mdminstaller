/**
 * Bundled by jsDelivr using Rollup v2.79.2 and Terser v5.39.0.
 * Original file: /npm/@yume-chan/adb@2.1.0/esm/index.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
import{BufferedReadableStream as e,MaybeConsumable as t,ConcatBufferStream as r,TextDecoderStream as s,ConcatStringStream as i,PushReadableStream as n,StructDeserializeStream as a,WritableStream as o,ReadableStream as c,AbortController as l,DistributionStream as d,BufferCombiner as h,Consumable as u,TransformStream as w,tryCancel as p,tryClose as f}from"/npm/@yume-chan/stream-extra@2.1.0/+esm";import{AutoDisposable as y,EventEmitter as g,StickyEventEmitter as b}from"/npm/@yume-chan/event@2.0.0/+esm";import{struct as m,u32 as v,buffer as k,StructEmptyError as S,string as E,extend as x,encodeUtf8 as A,ExactReadableEndedError as T,u8 as C,decodeUtf8 as I,u64 as D,s32 as P,EmptyUint8Array as L,bipedal as _,TextDecoder as z}from"/npm/@yume-chan/struct@2.0.1/+esm";export{decodeUtf8,encodeUtf8}from"/npm/@yume-chan/struct@2.0.1/+esm";import{PromiseResolver as O,AsyncOperationManager as R,delay as W}from"/npm/@yume-chan/async@4.1.3/+esm";import{getUint32LittleEndian as $,getUint64BigEndian as V,setInt64LittleEndian as F,setInt64BigEndian as B,setUint32LittleEndian as U,getUint64LittleEndian as N}from"/npm/@yume-chan/no-data-view@2.0.0/+esm";class M extends y{#e;get adb(){return this.#e}constructor(e){super(),this.#e=e}}const q=m({version:v},{littleEndian:!0}),j=m({bpp:v,size:v,width:v,height:v,red_offset:v,red_length:v,blue_offset:v,blue_length:v,green_offset:v,green_length:v,alpha_offset:v,alpha_length:v,data:k("size")},{littleEndian:!0}),K=m({bpp:v,colorSpace:v,size:v,width:v,height:v,red_offset:v,red_length:v,blue_offset:v,blue_length:v,green_offset:v,green_length:v,alpha_offset:v,alpha_length:v,data:k("size")},{littleEndian:!0});class Y extends Error{constructor(e,t){super(e,t)}}class H extends Y{constructor(e){super(`Unsupported FrameBuffer version ${e}`)}}class G extends Y{constructor(){super("FrameBuffer is disabled by current app")}}async function X(t){const r=await t.createSocket("framebuffer:"),s=new e(r.readable);let i;try{({version:i}=await q.deserialize(s))}catch(e){if(e instanceof S)throw new G;throw e}switch(i){case 1:return await j.deserialize(s);case 2:return await K.deserialize(s);default:throw new H(i)}}class Z extends M{reboot(e=""){return this.adb.createSocketAndWait(`reboot:${e}`)}bootloader(){return this.reboot("bootloader")}fastboot(){return this.reboot("fastboot")}recovery(){return this.reboot("recovery")}sideload(){return this.reboot("sideload")}qualcommEdlMode(){return this.reboot("edl")}powerOff(){return this.adb.subprocess.noneProtocol.spawnWaitText(["reboot","-p"])}powerButton(e=!1){const t=["input","keyevent"];return e&&t.push("--longpress"),t.push("POWER"),this.adb.subprocess.noneProtocol.spawnWaitText(t)}samsungOdin(){return this.reboot("download")}}class J{#t;#r=[];constructor(e=!1){this.#t=e}wait(){if(!this.#t&&(this.#t=!0,0===this.#r.length))return Promise.resolve();const e=new O;return this.#r.push(e),e.promise}notifyOne(){0!==this.#r.length?this.#r.pop().resolve():this.#t=!1}dispose(){for(const e of this.#r)e.reject(new Error("The AutoResetEvent has been disposed"));this.#r.length=0}}const[Q,ee,te]=(()=>{const e=[],t=[],r="=".charCodeAt(0);function s(r,s){const i=r.charCodeAt(0),n=s.charCodeAt(0);for(let r=i;r<=n;r+=1)e[r]=t.length,t.push(r)}return s("A","Z"),s("a","z"),s("0","9"),s("+","+"),s("/","/"),[e,t,r]})();function re(e){const t=e%3,r=0!==t?3-t:0;return[(e+r)/3*4,r]}function se(e,t){const[r,s]=re(e.length);if(t){if(t.length<r)throw new TypeError("output buffer is too small");if(t=t.subarray(0,r),e.buffer!==t.buffer)ie(e,t,s);else if(t.byteOffset+t.length-(s+1)<=e.byteOffset+e.length)ie(e,t,s);else{if(!(t.byteOffset>=e.byteOffset-1))throw new TypeError("input and output cannot overlap");!function(e,t,r){let s=e.length-1,i=t.length-1;if(2===r){const r=e[s];s-=1,t[i]=te,i-=1,t[i]=te,i-=1,t[i]=ee[(3&r)<<4],i-=1,t[i]=ee[r>>2],i-=1}else if(1===r){const r=e[s];s-=1;const n=e[s];s-=1,t[i]=te,i-=1,t[i]=ee[(15&r)<<2],i-=1,t[i]=ee[(3&n)<<4|r>>4],i-=1,t[i]=ee[n>>2],i-=1}for(;s>=0;){const r=e[s];s-=1;const n=e[s];s-=1;const a=e[s];s-=1,t[i]=ee[63&r],i-=1,t[i]=ee[(15&n)<<2|r>>6],i-=1,t[i]=ee[(3&a)<<4|n>>4],i-=1,t[i]=ee[a>>2],i-=1}}(e,t,s)}return r}return ie(e,t=new Uint8Array(r),s),t}function ie(e,t,r){let s=0,i=0;for(;s<e.length-2;){const r=e[s];s+=1;const n=e[s];s+=1;const a=e[s];s+=1,t[i]=ee[r>>2],i+=1,t[i]=ee[(3&r)<<4|n>>4],i+=1,t[i]=ee[(15&n)<<2|a>>6],i+=1,t[i]=ee[63&a],i+=1}if(2===r){const r=e[s];s+=1,t[i]=ee[r>>2],i+=1,t[i]=ee[(3&r)<<4],i+=1,t[i]=te,i+=1,t[i]=te}else if(1===r){const r=e[s];s+=1;const n=e[s];s+=1,t[i]=ee[r>>2],i+=1,t[i]=ee[(3&r)<<4|n>>4],i+=1,t[i]=ee[(15&n)<<2],i+=1,t[i]=te}}function ne(e){let t;t="="===e[e.length-2]?2:"="===e[e.length-1]?1:0;const r=new Uint8Array(e.length/4*3-t);let s=0,i=0;for(;s<e.length-(0!==t?4:0);){const t=Q[e.charCodeAt(s)];s+=1;const n=Q[e.charCodeAt(s)];s+=1;const a=Q[e.charCodeAt(s)];s+=1;const o=Q[e.charCodeAt(s)];s+=1,r[i]=t<<2|(48&n)>>4,i+=1,r[i]=(15&n)<<4|(60&a)>>2,i+=1,r[i]=(3&a)<<6|o,i+=1}if(1===t){const t=Q[e.charCodeAt(s)];s+=1;const n=Q[e.charCodeAt(s)];s+=1;const a=Q[e.charCodeAt(s)];r[i]=t<<2|(48&n)>>4,i+=1,r[i]=(15&n)<<4|(60&a)>>2}else if(2===t){const t=Q[e.charCodeAt(s)];s+=1;const n=Q[e.charCodeAt(s)];r[i]=t<<2|(48&n)>>4}return r}function ae(e){if(e<48)throw new TypeError(`Invalid hex char ${e}`);if(e<58)return e-48;if(e<65)throw new TypeError(`Invalid hex char ${e}`);if(e<71)return e-55;if(e<97)throw new TypeError(`Invalid hex char ${e}`);if(e<103)return e-87;throw new TypeError(`Invalid hex char ${e}`)}function oe(e){let t=0;for(let r=0;r<e.length;r+=1)t=t<<4|ae(e[r]);return t}function ce(e,t,r){const s=t;for(t+=3;t>=s&&r>0;){const s=15&r;r>>=4,e[t]=s<10?s+48:s+87,t-=1}for(;t>=s;)e[t]=48,t-=1}const le=()=>{};function de(...e){throw new Error("Unreachable. Arguments:\n"+e.join("\n"))}const{setInterval:he,clearInterval:ue}=globalThis;class we{#s;constructor(e){e?.unref||this.ref()}ref(){this.#s=he((()=>{}),6e4)}unref(){this.#s&&(ue(this.#s),this.#s=void 0)}}function pe(e,t){if(e.length!==t.length)return!1;for(let r=0;r<e.length;r+=1)if(e[r]!==t[r])return!1;return!0}const fe=m({length:E(4),content:E({field:"length",convert:e=>Number.parseInt(e,16),back:e=>e.toString(16).padStart(4,"0")})},{littleEndian:!0});class ye extends Error{constructor(e){super(e)}}class ge extends ye{constructor(){super("ADB reverse tunnel is not supported on this device when connected wirelessly.")}}const be=x(fe,{},{postDeserialize(e){throw"more than one device/emulator"===e.content?new ge:new ye(e.content)}});const me=A("OKAY");class ve extends M{#i=new Map;async createBufferedStream(t){const r=await this.adb.createSocket(t);return new e(r.readable)}async sendRequest(e){const t=await this.createBufferedStream(e);return pe(await t.readExactly(4),me)||await be.deserialize(t),t}async list(){const e=await this.createBufferedStream("reverse:list-forward");return(await fe.deserialize(e)).content.split("\n").filter((e=>!!e)).map((e=>{const[t,r,s]=e.split(" ");return{deviceSerial:t,localName:r,remoteName:s}}))}async addExternal(e,t){const r=await this.sendRequest(`reverse:forward:${e};${t}`);if(e.startsWith("tcp:")){const t=r.position;try{const t=oe(await r.readExactly(4)),s=function(e){let t=0;for(const r of e){if(r<48||r>57)return t;t=10*t+r-48}return t}(await r.readExactly(t));e=`tcp:${s}`}catch(e){if(!(e instanceof T&&r.position===t))throw e}}return e}async add(e,t,r){r=await this.adb.transport.addReverseTunnel(t,r);try{return e=await this.addExternal(e,r),this.#i.set(e,r),e}catch(e){throw await this.adb.transport.removeReverseTunnel(r),e}}async remove(e){const t=this.#i.get(e);t&&await this.adb.transport.removeReverseTunnel(t),await this.sendRequest(`reverse:killforward:${e}`)}async removeAll(){await this.adb.transport.clearReverseTunnels(),this.#i.clear(),await this.sendRequest("reverse:killforward-all")}}class ke{#n;get stdin(){return this.#n.writable}get output(){return this.#n.readable}#a;get exited(){return this.#a}constructor(e,t){if(this.#n=e,t){const e=new O;this.#n.closed.then((()=>e.resolve(void 0)),(t=>e.reject(t))),t.addEventListener("abort",(()=>{e.reject(t.reason),this.#n.close()})),this.#a=e.promise}else this.#a=this.#n.closed}kill(){return this.#n.close()}}class Se{#n;#o;#c;get input(){return this.#c}get output(){return this.#n.readable}get exited(){return this.#n.closed}constructor(e){this.#n=e,this.#o=this.#n.writable.getWriter(),this.#c=new t.WritableStream({write:e=>this.#o.write(e)})}sigint(){return this.#o.write(new Uint8Array([3]))}kill(){return this.#n.close()}}function Ee(e){let t="";t+="'";let r=0;for(;;){const s=e.indexOf("'",r);if(-1===s){t+=e.substring(r);break}t+=e.substring(r,s),t+=String.raw`'\''`,r=s+1}return t+="'",t}function xe(e){const t=[];let r,s=!1,i=0;for(let n=0,a=e.length;n<a;n+=1){if(s){s=!1;continue}const a=e.charAt(n);switch(a){case" ":r||n===i||(t.push(e.substring(i,n)),i=n+1);break;case"'":case'"':r?a===r&&(r=void 0):r=a;break;case"\\":s=!0}}return i<e.length&&t.push(e.substring(i)),t}class Ae{#l;constructor(e){this.#l=e}spawn(e,t){return t?.throwIfAborted(),"string"==typeof e&&(e=xe(e)),this.#l(e,t)}async spawnWait(e){const t=await this.spawn(e);return await t.output.pipeThrough(new r)}async spawnWaitText(e){const t=await this.spawn(e);return await t.output.pipeThrough(new s).pipeThrough(new i)}}class Te extends Ae{#e;get adb(){return this.#e}constructor(e){super((async(e,t)=>{const r=await this.#e.createSocket(`exec:${e.join(" ")}`);if(t?.aborted)throw await r.close(),t.reason;return new ke(r,t)})),this.#e=e}async pty(e){return void 0===e?e="":Array.isArray(e)&&(e=e.join(" ")),new Se(await this.#e.createSocket(`shell:${e}`))}}const Ce={ShellV2:"shell_v2",Cmd:"cmd",StatV2:"stat_v2",ListV2:"ls_v2",FixedPushMkdir:"fixed_push_mkdir",Abb:"abb",AbbExec:"abb_exec",SendReceiveV2:"sendrecv_v2",DelayedAck:"delayed_ack"},Ie={Stdin:0,Stdout:1,Stderr:2,Exit:3,CloseStdin:4,WindowSizeChange:5},De=m({id:C(),data:k(v)},{littleEndian:!0});class Pe{#n;#o;#d;get stdin(){return this.#d}#h;get stdout(){return this.#h}#u;get stderr(){return this.#u}#a;get exited(){return this.#a}constructor(e,r){let s,i;this.#n=e,this.#h=new n((e=>{s=e})),this.#u=new n((e=>{i=e}));const c=new O;this.#a=c.promise,e.readable.pipeThrough(new a(De)).pipeTo(new o({write:async e=>{switch(e.id){case Ie.Exit:c.resolve(e.data[0]);break;case Ie.Stdout:await s.enqueue(e.data);break;case Ie.Stderr:await i.enqueue(e.data)}}})).then((()=>{s.close(),i.close(),c.reject(new Error("Socket ended without exit message"))}),(e=>{s.error(e),i.error(e),c.reject(e)})),r&&r.addEventListener("abort",(()=>{c.reject(r.reason),this.#n.close()})),this.#o=this.#n.writable.getWriter(),this.#d=new t.WritableStream({write:async e=>{await this.#o.write(De.serialize({id:Ie.Stdin,data:e}))}})}kill(){return this.#n.close()}}class Le{#n;#o;#c;get input(){return this.#c}#h;get output(){return this.#h}#a=new O;get exited(){return this.#a.promise}constructor(e){let r;this.#n=e,this.#h=new n((e=>{r=e})),e.readable.pipeThrough(new a(De)).pipeTo(new o({write:async e=>{switch(e.id){case Ie.Exit:this.#a.resolve(e.data[0]);break;case Ie.Stdout:await r.enqueue(e.data)}}})).then((()=>{r.close(),this.#a.reject(new Error("Socket ended without exit message"))}),(e=>{r.error(e),this.#a.reject(e)})),this.#o=this.#n.writable.getWriter(),this.#c=new t.WritableStream({write:e=>this.#w(e)})}#w(e){return this.#o.write(De.serialize({id:Ie.Stdin,data:e}))}async resize(e,t){await this.#o.write(De.serialize({id:Ie.WindowSizeChange,data:A(`${e}x${t},0x0\0`)}))}sigint(){return this.#w(new Uint8Array([3]))}kill(){return this.#n.close()}}class _e{#l;constructor(e){this.#l=e}spawn(e,t){return t?.throwIfAborted(),"string"==typeof e&&(e=xe(e)),this.#l(e,t)}async spawnWait(e){const t=await this.spawn(e),[s,i,n]=await Promise.all([t.stdout.pipeThrough(new r),t.stderr.pipeThrough(new r),t.exited]);return{stdout:s,stderr:i,exitCode:n}}async spawnWaitText(e){const t=await this.spawn(e),[r,n,a]=await Promise.all([t.stdout.pipeThrough(new s).pipeThrough(new i),t.stderr.pipeThrough(new s).pipeThrough(new i),t.exited]);return{stdout:r,stderr:n,exitCode:a}}}class ze extends _e{#e;get adb(){return this.#e}get isSupported(){return this.#e.canUseFeature(Ce.ShellV2)}constructor(e){super((async(e,t)=>{const r=await this.#e.createSocket(`shell,v2,raw:${e.join(" ")}`);if(t?.aborted)throw await r.close(),t.reason;return new Pe(r,t)})),this.#e=e}async pty(e){let t="shell,v2,pty";return e?.terminalType&&(t+=",TERM="+e.terminalType),t+=":",e&&("string"==typeof e.command?t+=e.command:Array.isArray(e.command)&&(t+=e.command.join(" "))),new Le(await this.#e.createSocket(t))}}class Oe{#e;get adb(){return this.#e}#p;get noneProtocol(){return this.#p}#f;get shellProtocol(){return this.#f}constructor(e){this.#e=e,this.#p=new Te(e),e.canUseFeature(Ce.ShellV2)&&(this.#f=new ze(e))}}function Re(e){const t=function(e){const t=new Uint8Array(e.length);for(let r=0;r<e.length;r+=1)t[r]=e.charCodeAt(r);return t}(e);return $(t,0)}const We={Entry:Re("DENT"),Entry2:Re("DNT2"),Lstat:Re("STAT"),Stat:Re("STA2"),Lstat2:Re("LST2"),Done:Re("DONE"),Data:Re("DATA"),Ok:Re("OKAY"),Fail:Re("FAIL")};class $e extends Error{}const Ve=m({message:E(v)},{littleEndian:!0,postDeserialize(e){throw new $e(e.message)}});async function Fe(e,t,r){"string"==typeof t&&(t=Re(t));const s=await e.readExactly(4);switch($(s,0)){case We.Fail:throw await Ve.deserialize(e),new Error("Unreachable");case t:return await r.deserialize(e);default:throw new Error(`Expected '${t}', but got '${I(s)}'`)}}async function*Be(e,t,r){for("string"==typeof t&&(t=Re(t));;){const s=await e.readExactly(4);switch($(s,0)){case We.Fail:await Ve.deserialize(e),de();case We.Done:return void await e.readExactly(r.size);case t:yield await r.deserialize(e);break;default:throw new Error(`Expected '${t}' or '${We.Done}', but got '${I(s)}'`)}}}const Ue={List:Re("LIST"),ListV2:Re("LIS2"),Send:Re("SEND"),SendV2:Re("SND2"),Lstat:Re("STAT"),Stat:Re("STA2"),LstatV2:Re("LST2"),Data:Re("DATA"),Done:Re("DONE"),Receive:Re("RECV")},Ne=m({id:v,arg:v},{littleEndian:!0});async function Me(e,t,r){"string"==typeof t&&(t=Re(t)),"number"!=typeof r?("string"==typeof r&&(r=A(r)),await e.write(Ne.serialize({id:t,arg:r.length})),await e.write(r)):await e.write(Ne.serialize({id:t,arg:r}))}const qe={Directory:4,File:8,Link:10},je=m({mode:v,size:v,mtime:v},{littleEndian:!0,extra:{get type(){return this.mode>>12},get permission(){return 4095&this.mode}},postDeserialize(e){if(0===e.mode&&0===e.size&&0===e.mtime)throw new Error("lstat error");return e}}),Ke={SUCCESS:0,EACCES:13,EEXIST:17,EFAULT:14,EFBIG:27,EINTR:4,EINVAL:22,EIO:5,EISDIR:21,ELOOP:40,EMFILE:24,ENAMETOOLONG:36,ENFILE:23,ENOENT:2,ENOMEM:12,ENOSPC:28,ENOTDIR:20,EOVERFLOW:75,EPERM:1,EROFS:30,ETXTBSY:26},Ye=(()=>Object.fromEntries(Object.entries(Ke).map((([e,t])=>[t,e]))))(),He=m({error:v(),dev:D,ino:D,mode:v,nlink:v,uid:v,gid:v,size:D,atime:D,mtime:D,ctime:D},{littleEndian:!0,extra:{get type(){return this.mode>>12},get permission(){return 4095&this.mode}},postDeserialize(e){if(e.error)throw new Error(Ye[e.error]);return e}});async function Ge(e,t,r){const s=await e.lock();try{if(r)return await Me(s,Ue.LstatV2,t),await Fe(s,We.Lstat2,He);{await Me(s,Ue.Lstat,t);const e=await Fe(s,We.Lstat,je);return{mode:e.mode,size:BigInt(e.size),mtime:BigInt(e.mtime),get type(){return e.type},get permission(){return e.permission}}}}finally{s.release()}}async function Xe(e,t){const r=await e.lock();try{return await Me(r,Ue.Stat,t),await Fe(r,We.Stat,He)}finally{r.release()}}const Ze=x(je,{name:E(v)}),Je=x(He,{name:E(v)});async function*Qe(e,t){const r=await e.lock();try{await Me(r,Ue.ListV2,t);for await(const e of Be(r,We.Entry2,Je))e.error===Ke.SUCCESS&&(yield e)}finally{r.release()}}async function*et(e,t){const r=await e.lock();try{await Me(r,Ue.List,t);for await(const e of Be(r,We.Entry,Ze))yield e}finally{r.release()}}async function*tt(e,t,r){if(r)yield*Qe(e,t);else for await(const r of et(e,t))yield{mode:r.mode,size:BigInt(r.size),mtime:BigInt(r.mtime),get type(){return r.type},get permission(){return r.permission},name:r.name}}const rt=m({data:k(v)},{littleEndian:!0});async function*st(e,t){const r=await e.lock();let s=!1;try{await Me(r,Ue.Receive,t);for await(const e of Be(r,We.Data,rt))yield e.data;s=!0}catch(e){throw s=!0,e}finally{if(!s)for await(const e of Be(r,We.Data,rt));r.release()}}function it(e,t){return c.from(st(e,t))}const nt=65536,at=m({unused:v},{littleEndian:!0});async function ot(e,r,s,i){const n=new l;r.pipeThrough(new d(s,!0)).pipeTo(new t.WritableStream({write:t=>Me(e,Ue.Data,t)}),{signal:n.signal}).then((async()=>{await Me(e,Ue.Done,i),await e.flush()}),le),await Fe(e,We.Ok,at).catch((e=>{throw n.abort(),e}))}async function ct({socket:e,filename:t,file:r,type:s=qe.File,permission:i=438,mtime:n=Date.now()/1e3|0,packetSize:a=65536}){const o=await e.lock();try{const e=`${t},${(s<<12|i).toString()}`;await Me(o,Ue.Send,e),await ot(o,r,a,n)}finally{o.release()}}const lt={None:0,Brotli:1,Lz4:2,Zstd:4,DryRun:2147483648},dt=m({id:v,mode:v,flags:v()},{littleEndian:!0});async function ht({socket:e,filename:t,file:r,type:s=qe.File,permission:i=438,mtime:n=Date.now()/1e3|0,packetSize:a=65536,dryRun:o=!1}){const c=await e.lock();try{await Me(c,Ue.SendV2,t);const e=s<<12|i;let l=lt.None;o&&(l|=lt.DryRun),await c.write(dt.serialize({id:Ue.SendV2,mode:e,flags:l})),await ot(c,r,a,n)}finally{c.release()}}function ut(e){if(e.v2)return ht(e);if(e.dryRun)throw new Error("dryRun is not supported in v1");return ct(e)}class wt{#o;#y;#g;#b=new J;#m;get position(){return this.#y.position}constructor(e,t,r,s){this.#o=e,this.#y=t,this.#g=s,this.#m=new h(r)}#v(e){return u.WritableStream.write(this.#o,e)}async flush(){try{await this.#b.wait();const e=this.#m.flush();e&&await this.#v(e)}finally{this.#b.notifyOne()}}async write(e){try{await this.#b.wait();for(const t of this.#m.push(e))await this.#v(t)}finally{this.#b.notifyOne()}}async readExactly(e){return await this.flush(),await this.#y.readExactly(e)}release(){this.#m.flush(),this.#g.notifyOne()}async close(){await this.#y.cancel()}}class pt{#k=new J;#n;#S;constructor(t,r){this.#n=t,this.#S=new wt(t.writable.getWriter(),new e(t.readable),r,this.#k)}async lock(){return await this.#k.wait(),this.#S}async close(){await this.#S.close(),await this.#n.close()}}function ft(e){const t=e.lastIndexOf("/");if(-1===t)throw new Error("Invalid path");return 0===t?"/":e.substring(0,t)}class yt{_adb;_socket;#E;#x;#A;#T;#C;get supportsStat(){return this.#E}get supportsListV2(){return this.#x}get fixedPushMkdir(){return this.#A}get supportsSendReceiveV2(){return this.#T}get needPushMkdirWorkaround(){return this.#C}constructor(e,t){this._adb=e,this._socket=new pt(t,e.maxPayloadSize),this.#E=e.canUseFeature(Ce.StatV2),this.#x=e.canUseFeature(Ce.ListV2),this.#A=e.canUseFeature(Ce.FixedPushMkdir),this.#T=e.canUseFeature(Ce.SendReceiveV2),this.#C=this._adb.canUseFeature(Ce.ShellV2)&&!this.fixedPushMkdir}async lstat(e){return await Ge(this._socket,e,this.#E)}async stat(e){if(!this.#E)throw new Error("Not supported");return await Xe(this._socket,e)}async isDirectory(e){try{return await this.lstat(e+"/"),!0}catch{return!1}}opendir(e){return tt(this._socket,e,this.supportsListV2)}async readdir(e){const t=[];for await(const r of this.opendir(e))t.push(r);return t}read(e){return it(this._socket,e)}async write(e){this.needPushMkdirWorkaround&&await this._adb.subprocess.noneProtocol.spawnWait(["mkdir","-p",Ee(ft(e.filename))]),await ut({v2:this.supportsSendReceiveV2,socket:this._socket,...e})}lockSocket(){return this._socket.lock()}dispose(){return this._socket.close()}}function gt(e){if(e&&"0"!==e)return Number.parseInt(e,10)}class bt extends M{async getListenAddresses(){const e=await this.adb.getProp("service.adb.listen_addrs"),t=await this.adb.getProp("service.adb.tcp.port"),r=await this.adb.getProp("persist.adb.tcp.port");return{serviceListenAddresses:""!=e?e.split(","):[],servicePort:gt(t),persistPort:gt(r)}}async setPort(e){if(e<=0)throw new TypeError(`Invalid port ${e}`);const t=await this.adb.createSocketAndWait(`tcpip:${e}`);if(t!==`restarting in TCP mode port: ${e}\n`)throw new Error(t);return t}async disable(){const e=await this.adb.createSocketAndWait("usb:");if("restarting in USB mode\n"!==e)throw new Error(e);return e}}class mt{#I;get transport(){return this.#I}get serial(){return this.#I.serial}get maxPayloadSize(){return this.#I.maxPayloadSize}get banner(){return this.#I.banner}get disconnected(){return this.#I.disconnected}get clientFeatures(){return this.#I.clientFeatures}get deviceFeatures(){return this.banner.features}subprocess;power;reverse;tcpip;constructor(e){this.#I=e,this.subprocess=new Oe(this),this.power=new Z(this),this.reverse=new ve(this),this.tcpip=new bt(this)}canUseFeature(e){return this.clientFeatures.includes(e)&&this.deviceFeatures.includes(e)}async createSocket(e){return this.#I.connect(e)}async createSocketAndWait(e){const t=await this.createSocket(e);return await t.readable.pipeThrough(new s).pipeThrough(new i)}getProp(e){return this.subprocess.noneProtocol.spawnWaitText(["getprop",e]).then((e=>e.trim()))}rm(e,t){const r=["rm"];if(t?.recursive&&r.push("-r"),t?.force&&r.push("-f"),Array.isArray(e))for(const t of e)r.push(Ee(t));else r.push(Ee(e));return r.push("</dev/null"),this.subprocess.noneProtocol.spawnWaitText(r)}async sync(){const e=await this.createSocket("sync:");return new yt(this,e)}async framebuffer(){return X(this)}async close(){await this.#I.close()}}const vt={Product:"ro.product.name",Model:"ro.product.model",Device:"ro.product.device",Features:"features"};class kt{static parse(e){let t,r,s,i=[];const n=e.split("::");if(n.length>1){const e=n[1];for(const n of e.split(";")){if(!n)continue;const e=n.split("=");if(2!==e.length)continue;const[a,o]=e;switch(a){case vt.Product:t=o;break;case vt.Model:r=o;break;case vt.Device:s=o;break;case vt.Features:i=o.split(",")}}}return new kt(t,r,s,i)}#D;get product(){return this.#D}#P;get model(){return this.#P}#L;get device(){return this.#L}#_=[];get features(){return this.#_}constructor(e,t,r,s){this.#D=e,this.#P=t,this.#L=r,this.#_=s}}function St(e,t,r){let s=0n;for(let i=t;i<t+r;i+=8){s<<=64n;s|=V(e,i)}return s}function Et(e,t,r,s,i){if(i)for(;s>0n;)F(e,t,s),t+=8,s>>=64n;else{let i=t+r-8;for(;s>0n;)B(e,i,s),i-=8,s>>=64n}}function xt(e){return[St(e,38,256),St(e,303,256)]}function At(e,t){const r=e%t;return r>0?r:r+(t>0?t:-t)}function Tt(e,t){if(!(e=At(e,t))||t<2)return NaN;const r=[];let s=t;for(;s;)[e,s]=[s,e%s],r.push({a:e,b:s});if(1!==e)return NaN;let i=1,n=0;for(let e=r.length-2;e>=0;e-=1)[i,n]=[n,i-n*Math.floor(r[e].a/r[e].b)];return At(n,t)}const Ct=256;function It(){return 524}function Dt(e,t){let r;if(t){if(t.length<524)throw new TypeError("output buffer is too small");r="number"}else t=new Uint8Array(524),r="Uint8Array";const s=new DataView(t.buffer,t.byteOffset,t.length);let i=0;s.setUint32(i,64,!0),i+=4;const[n]=xt(e),a=-Tt(Number(n%2n**32n),2**32);s.setInt32(i,a,!0),i+=4,Et(t,i,Ct,n,!0),i+=Ct;return Et(t,i,Ct,2n**4096n%n,!0),i+=Ct,s.setUint32(i,65537,!0),i+=4,"Uint8Array"===r?t:524}function Pt(e,t,r){if(1n===r)return 0n;let s=1n;for(e%=r;t>0n;)1n===BigInt.asUintN(1,t)&&(s=s*e%r),e=e*e%r,t>>=1n;return s}const Lt=20,_t=48,zt=4,Ot=5,Rt=6,Wt=new Uint8Array([48,33,48,9,6,5,43,14,3,2,26,5,0,4,20]);function $t(e,t){const[r,s]=xt(e),i=new Uint8Array(256);let n=0;i[n]=0,n+=1,i[n]=1,n+=1;const a=i.length-Wt.length-t.length-1;for(;n<a;)i[n]=255,n+=1;i[n]=0,n+=1,i.set(Wt,n),n+=Wt.length,i.set(t,n);const o=Pt(St(i,0,i.length),s,r);return Et(i,0,i.length,o,!1),i}const Vt={Auth:1213486401,Close:1163086915,Connect:1314410051,Okay:1497451343,Open:1313165391,Write:1163154007},Ft=m({command:v,arg0:v,arg1:v,payloadLength:v,checksum:v,magic:P},{littleEndian:!0}),Bt=x(Ft,{payload:k("payloadLength")});function Ut(e){return e.reduce(((e,t)=>e+t),0)}class Nt extends w{constructor(){const e=new Uint8Array(Ft.size);super({transform:async(t,r)=>{await t.tryConsume((async t=>{const s=t;s.payloadLength=s.payload.length,Ft.serialize(s,e),await u.ReadableStream.enqueue(r,e),s.payloadLength&&await u.ReadableStream.enqueue(r,s.payload)}))}})}}const Mt={Token:1,Signature:2,PublicKey:3},qt=async function*(e,t){for await(const r of e.iterateKeys()){const e=await t();if(e.arg0!==Mt.Token)return;const s=$t(r.buffer,e.payload);yield{command:Vt.Auth,arg0:Mt.Signature,arg1:0,payload:s}}},jt=async function*(e,t){if((await t()).arg0!==Mt.Token)return;let r;for await(const t of e.iterateKeys()){r=t;break}r||(r=await e.generateKey());const[s]=re(524),i=r.name?.length?A(r.name):L,n=new Uint8Array(s+(i.length?i.length+1:0)+1);Dt(r.buffer,n),se(n.subarray(0,524),n),i.length&&(n[s]=32,n.set(i,s+1)),yield{command:Vt.Auth,arg0:Mt.PublicKey,arg1:0,payload:n}},Kt=[qt,jt];class Yt{authenticators;#z;#O=new O;#R;constructor(e,t){this.authenticators=e,this.#z=t}#W=()=>this.#O.promise;async*#$(){for(const e of this.authenticators)for await(const t of e(this.#z,this.#W))this.#O=new O,yield t}async process(e){this.#R||(this.#R=this.#$()),this.#O.resolve(e);const t=await this.#R.next();if(t.done)throw new Error("No authenticator can handle the request");return t.value}dispose(){this.#R?.return?.()}}class Ht{#V;localId;remoteId;localCreated;service;#y;#F;get readable(){return this.#y}#B;writable;#U=!1;#N=new O;get closed(){return this.#N.promise}#n;get socket(){return this.#n}#M;#q=0;constructor(e){this.#V=e.dispatcher,this.localId=e.localId,this.remoteId=e.remoteId,this.localCreated=e.localCreated,this.service=e.service,this.#y=new n((e=>{this.#F=e})),this.writable=new t.WritableStream({start:e=>{this.#B=e,e.signal.addEventListener("abort",(()=>{this.#M?.reject(e.signal.reason)}))},write:async e=>{const t=e.length,r=this.#V.options.maxPayloadSize;for(let s=0,i=r;s<t;s=i,i+=r){const t=e.subarray(s,i);await this.#j(t)}}}),this.#n=new Gt(this),this.#q=e.availableWriteBytes}async#j(e){const t=e.length;for(;this.#q<t;){const e=new O;this.#M=e,await e.promise}this.#q===1/0?this.#q=-1:this.#q-=t,await this.#V.sendPacket(Vt.Write,this.localId,this.remoteId,e)}async enqueue(e){await this.#F.enqueue(e)}ack(e){this.#q+=e,this.#M?.resolve()}async close(){if(!this.#U){this.#U=!0,this.#M?.reject(new Error("Socket closed"));try{this.#B.error(new Error("Socket closed"))}catch{}await this.#V.sendPacket(Vt.Close,this.localId,this.remoteId,L)}}dispose(){this.#F.close(),this.#N.resolve(void 0)}}class Gt{#K;get localId(){return this.#K.localId}get remoteId(){return this.#K.remoteId}get localCreated(){return this.#K.localCreated}get service(){return this.#K.service}get readable(){return this.#K.readable}get writable(){return this.#K.writable}get closed(){return this.#K.closed}constructor(e){this.#K=e}close(){return this.#K.close()}}class Xt{#Y=new R(1);#H=new Map;#o;options;#U=!1;#G=new O;get disconnected(){return this.#G.promise}#X=new Map;#Z=new l;constructor(e,t){this.options=t,this.options.initialDelayedAckBytes<0&&(this.options.initialDelayedAckBytes=0),e.readable.pipeTo(new o({write:async e=>{switch(e.command){case Vt.Close:await this.#J(e);break;case Vt.Okay:this.#Q(e);break;case Vt.Open:await this.#ee(e);break;case Vt.Write:await this.#te(e);break;default:throw new Error(`Unknown command: ${e.command.toString(16)}`)}}}),{preventCancel:t.preserveConnection??!1,signal:this.#Z.signal}).then((()=>{this.#re()}),(e=>{this.#U||this.#G.reject(e),this.#re()})),this.#o=e.writable.getWriter()}async#J(e){if(0===e.arg0&&this.#Y.reject(e.arg1,new Error("Socket open failed")))return;const t=this.#H.get(e.arg1);return t?(await t.close(),t.dispose(),void this.#H.delete(e.arg1)):void 0}#Q(e){let t;if(0!==this.options.initialDelayedAckBytes){if(4!==e.payload.length)throw new Error("Invalid OKAY packet. Payload size should be 4");t=$(e.payload,0)}else{if(0!==e.payload.length)throw new Error("Invalid OKAY packet. Payload size should be 0");t=1/0}if(this.#Y.resolve(e.arg1,{remoteId:e.arg0,availableWriteBytes:t}))return;const r=this.#H.get(e.arg1);r?r.ack(t):this.sendPacket(Vt.Close,e.arg1,e.arg0,L)}#se(e,t,r){let s;return 0!==this.options.initialDelayedAckBytes?(s=new Uint8Array(4),U(s,0,r)):s=L,this.sendPacket(Vt.Okay,e,t,s)}async#ee(e){const[t]=this.#Y.add();this.#Y.resolve(t,void 0);const r=e.arg0;let s=e.arg1,i=I(e.payload);if(i.endsWith("\0")&&(i=i.substring(0,i.length-1)),0===this.options.initialDelayedAckBytes){if(0!==s)throw new Error("Invalid OPEN packet. arg1 should be 0");s=1/0}else if(0===s)throw new Error("Invalid OPEN packet. arg1 should be greater than 0");const n=this.#X.get(i);if(!n)return void await this.sendPacket(Vt.Close,0,r,L);const a=new Ht({dispatcher:this,localId:t,remoteId:r,localCreated:!1,service:i,availableWriteBytes:s});try{await n(a.socket),this.#H.set(t,a),await this.#se(t,r,this.options.initialDelayedAckBytes)}catch{await this.sendPacket(Vt.Close,0,r,L)}}async#te(e){const t=this.#H.get(e.arg1);if(!t)throw new Error(`Unknown local socket id: ${e.arg1}`);let r=!1;const s=[(async()=>{await t.enqueue(e.payload),await this.#se(e.arg1,e.arg0,e.payload.length),r=!0})()];this.options.readTimeLimit&&s.push((async()=>{if(await W(this.options.readTimeLimit),!r)throw new Error(`readable of \`${t.service}\` has stalled for ${this.options.readTimeLimit} milliseconds`)})()),await Promise.race(s)}async createSocket(e){this.options.appendNullToServiceString&&(e+="\0");const[t,r]=this.#Y.add();await this.sendPacket(Vt.Open,t,this.options.initialDelayedAckBytes,e);const{remoteId:s,availableWriteBytes:i}=await r,n=new Ht({dispatcher:this,localId:t,remoteId:s,localCreated:!0,service:e,availableWriteBytes:i});return this.#H.set(t,n),n.socket}addReverseTunnel(e,t){this.#X.set(e,t)}removeReverseTunnel(e){this.#X.delete(e)}clearReverseTunnels(){this.#X.clear()}async sendPacket(e,t,r,s){if("string"==typeof s&&(s=A(s)),s.length>this.options.maxPayloadSize)throw new TypeError("payload too large");await u.WritableStream.write(this.#o,{command:e,arg0:t,arg1:r,payload:s,checksum:this.options.calculateChecksum?Ut(s):0,magic:4294967295^e})}async close(){await Promise.all(Array.from(this.#H.values(),(e=>e.close()))),this.#U=!0,this.#Z.abort(),this.options.preserveConnection?this.#o.releaseLock():await this.#o.close()}#re(){for(const e of this.#H.values())e.dispose();this.#G.resolve()}}const Zt=16777217,Jt=(()=>[Ce.ShellV2,Ce.Cmd,Ce.StatV2,Ce.ListV2,Ce.FixedPushMkdir,"apex",Ce.Abb,"fixed_push_symlink_timestamp",Ce.AbbExec,"remount_shell","track_app",Ce.SendReceiveV2,"sendrecv_v2_brotli","sendrecv_v2_lz4","sendrecv_v2_zstd","sendrecv_v2_dry_run_send",Ce.DelayedAck])(),Qt=33554432;class er{static async authenticate({serial:e,connection:t,credentialStore:r,authenticators:s=Kt,features:i=Jt,initialDelayedAckBytes:n=33554432,...a}){let c=16777217,d=1048576;const h=new O,w=new Yt(s,r),p=new l,f=t.readable.pipeTo(new o({async write(e){switch(e.command){case Vt.Connect:c=Math.min(c,e.arg0),d=Math.min(d,e.arg1),h.resolve(I(e.payload));break;case Vt.Auth:{const t=await w.process(e);await g(t);break}}}}),{preventCancel:!0,signal:p.signal}).then((()=>{h.reject(new Error("Connection closed unexpectedly"))}),(e=>{h.reject(e)})),y=t.writable.getWriter();async function g(e){e.checksum=Ut(e.payload),e.magic=4294967295^e.command,await u.WritableStream.write(y,e)}const b=i.slice();if(n<=0){const e=i.indexOf(Ce.DelayedAck);-1!==e&&b.splice(e,1)}let m;try{await g({command:Vt.Connect,arg0:c,arg1:d,payload:A(`host::features=${b.join(",")}`)}),m=await h.promise}finally{p.abort(),y.releaseLock(),await f}return new er({serial:e,connection:t,version:c,maxPayloadSize:d,banner:m,features:b,initialDelayedAckBytes:n,...a})}#ie;get connection(){return this.#ie}#V;#ne;get serial(){return this.#ne}#ae;get protocolVersion(){return this.#ae}get maxPayloadSize(){return this.#V.options.maxPayloadSize}#oe;get banner(){return this.#oe}get disconnected(){return this.#V.disconnected}#ce;get clientFeatures(){return this.#ce}constructor({serial:e,connection:t,version:r,banner:s,features:i=Jt,initialDelayedAckBytes:n,...a}){if(this.#ne=e,this.#ie=t,this.#oe=kt.parse(s),this.#ce=i,i.includes(Ce.DelayedAck)){if(n<=0)throw new TypeError("`initialDelayedAckBytes` must be greater than 0 when DelayedAck feature is enabled.");this.#oe.features.includes(Ce.DelayedAck)||(n=0)}else n=0;let o,c;r>=Zt?(o=!1,c=!1):(o=!0,c=!0),this.#V=new Xt(t,{calculateChecksum:o,appendNullToServiceString:c,initialDelayedAckBytes:n,...a}),this.#ae=r}connect(e){return this.#V.createSocket(e)}addReverseTunnel(e,t){if(!t){t=`localabstract:reverse_${Math.random().toString().substring(2)}`}return this.#V.addReverseTunnel(t,e),t}removeReverseTunnel(e){this.#V.removeReverseTunnel(e)}clearReverseTunnels(){this.#V.clearReverseTunnels()}close(){return this.#V.close()}}class tr{#le;constructor(e){this.#le=e}async check(){const e=await this.#le.createConnection("host:mdns:check");try{return!(await e.readString()).startsWith("ERROR:")}finally{await e.dispose()}}async getServices(){const e=await this.#le.createConnection("host:mdns:services");try{return(await e.readString()).split("\n").filter(Boolean).map((e=>{const t=e.split("\t");return{name:t[0],service:t[1],address:t[2]}}))}finally{await e.dispose()}}}const rr=A("OKAY"),sr=A("FAIL");class ir{#ie;#de;#o;constructor(t){this.#ie=t,this.#de=new e(t.readable),this.#o=t.writable.getWriter()}readExactly(e){return this.#de.readExactly(e)}readString=_((function*(e){const t=oe(yield*e(this.readExactly(4)));if(0===t)return"";{const r=new z;let s="";const i=this.#de.iterateExactly(t);for(;;){const{done:t,value:n}=i.next();if(t)break;s+=r.decode(yield*e(n),{stream:!0})}return s+=r.decode(),s}}));async readOkay(){const e=await this.readExactly(4);if(!pe(e,rr)){if(pe(e,sr)){const e=await this.readString();throw new Error(e)}throw new Error(`Unexpected response: ${I(e)}`)}}async writeString(e){const t=A(e),r=new Uint8Array(4+t.length);ce(r,0,t.length),r.set(t,4),await this.#o.write(r)}release(){return this.#o.releaseLock(),{readable:this.#de.release(),writable:this.#ie.writable,closed:this.#ie.closed,close:()=>this.#ie.close()}}async dispose(){p(this.#de),f(this.#o),await this.#ie.close()}}class nr extends Error{constructor(e){super(e),this.name="NetworkError"}}class ar extends Error{constructor(e){super(e),this.name="UnauthorizedError"}}class or extends Error{constructor(e){super(e),this.name="AlreadyConnectedError"}}class cr{#le;constructor(e){this.#le=e}async pair(e,t){const r=await this.#le.createConnection(`host:pair:${t}:${e}`);try{const e=await r.readExactly(4);if(pe(e,sr))throw new Error(await r.readString());const t=oe(e);await r.readExactly(t)}finally{await r.dispose()}}async connect(e){const t=await this.#le.createConnection(`host:connect:${e}`);try{const r=await t.readString();switch(r){case`already connected to ${e}`:throw new or(r);case`failed to connect to ${e}`:case`failed to authenticate to ${e}`:throw new ar(r);case`connected to ${e}`:return;default:throw new nr(r)}}finally{await t.dispose()}}async disconnect(e){const t=await this.#le.createConnection(`host:disconnect:${e}`);try{await t.readString()}finally{await t.dispose()}}}function lr(e,t){t<0||t>=e.length||(e[t]=e[e.length-1],e.length-=1)}function dr(e,t){return e.filter((e=>t.includes(e.state)))}class hr{current=[];#le;#he;#ue=[];constructor(e){this.#le=e}async#we(e){const t=await e.readString(),r=pr.parseDeviceList(t),s=this.current.slice(),i=[];for(const e of r){const t=s.findIndex((t=>t.transportId===e.transportId));-1!==t?lr(s,t):i.push(e)}if(this.current=r,i.length)for(const e of this.#ue){const t=dr(i,e.includeStates);t.length&&e.onDeviceAdd.fire(t)}if(s.length)for(const e of this.#ue){dr(i,e.includeStates).length&&e.onDeviceRemove.fire(s)}for(const e of this.#ue){const t=dr(this.current,e.includeStates);e.onListChange.fire(t)}}async#pe(e){try{for(;;)await this.#we(e)}catch(e){this.#he=void 0;for(const t of this.#ue)t.onError.fire(e)}}async#fe(){const e=await this.#le.createConnection("host:track-devices-l",{unref:!0});return await this.#we(e),this.#pe(e),e}async#ye(e){0===this.#ue.length&&(this.#he=void 0,await e.dispose())}async createObserver(e){e?.signal?.throwIfAborted();let t=[];const r=new g,s=new g,i=new b,n=new b,a=e?.includeStates??["device","unauthorized"],o={includeStates:a,onDeviceAdd:r,onDeviceRemove:s,onListChange:i,onError:n};let c;if(this.#ue.push(o),i.event((e=>t=e)),this.#he)c=await this.#he,i.fire(dr(this.current,a));else{this.#he=this.#fe();try{c=await this.#he}catch(e){throw this.#he=void 0,e}}const l=new we(e),d=async()=>{lr(this.#ue,this.#ue.indexOf(o)),await this.#ye(c),l.unref()};if(e?.signal){if(e.signal.aborted)throw await d(),e.signal.reason;e.signal.addEventListener("abort",(()=>{d()}))}return{onDeviceAdd:r.event,onDeviceRemove:s.event,onListChange:i.event,onError:n.event,get current(){return t},stop:d}}}const ur=(()=>[Ce.ShellV2,Ce.Cmd,Ce.StatV2,Ce.ListV2,Ce.FixedPushMkdir,"apex",Ce.Abb,"fixed_push_symlink_timestamp",Ce.AbbExec,"remount_shell","track_app",Ce.SendReceiveV2,"sendrecv_v2_brotli","sendrecv_v2_lz4","sendrecv_v2_zstd","sendrecv_v2_dry_run_send"])();class wr{#le;serial;transportId;maxPayloadSize=1048576;banner;#H=[];#U=new O;#G;get disconnected(){return this.#G}get clientFeatures(){return ur}constructor(e,t,r,s,i){this.#le=e,this.serial=t,this.banner=r,this.transportId=s,this.#G=Promise.race([this.#U.promise,i])}async connect(e){const t=await this.#le.createDeviceConnection({transportId:this.transportId},e);return this.#H.push(t),t}async addReverseTunnel(e,t){return await this.#le.connector.addReverseTunnel(e,t)}async removeReverseTunnel(e){await this.#le.connector.removeReverseTunnel(e)}async clearReverseTunnels(){await this.#le.connector.clearReverseTunnels()}async close(){for(const e of this.#H)await e.close();this.#H.length=0,this.#U.resolve()}}class pr{static NetworkError=nr;static UnauthorizedError=ar;static AlreadyConnectedError=or;static parseDeviceList(e,t=["device","unauthorized"]){const r=[];for(const s of e.split("\n")){if(!s)continue;const e=s.split(" ").filter(Boolean),i=e[0],n=e[1];if(!t.includes(n))continue;let a,o,c,l;for(let t=2;t<e.length;t+=1){const[r,s]=e[t].split(":");switch(r){case"product":a=s;break;case"model":o=s;break;case"device":c=s;break;case"transport_id":l=BigInt(s)}}if(!l)throw new Error(`No transport id for device ${i}`);r.push({serial:i,state:n,authenticating:"unauthorized"===n,product:a,model:o,device:c,transportId:l})}return r}static formatDeviceService(e,t){if(!e)return`host:${t}`;if("transportId"in e)return`host-transport-id:${e.transportId}:${t}`;if("serial"in e)return`host-serial:${e.serial}:${t}`;if("usb"in e)return`host-usb:${t}`;if("tcp"in e)return`host-local:${t}`;throw new TypeError("Invalid device selector")}connector;wireless=new cr(this);mDns=new tr(this);#ge=new hr(this);constructor(e){this.connector=e}async createConnection(e,t){const r=await this.connector.connect(t),s=new ir(r);try{await s.writeString(e)}catch(e){throw await s.dispose(),e}try{return await fr((()=>s.readOkay()),t?.signal),s}catch(e){throw await s.dispose(),e}}async getVersion(){const e=await this.createConnection("host:version");try{const t=oe(await e.readExactly(4));return oe(await e.readExactly(t))}finally{await e.dispose()}}async validateVersion(e){const t=await this.getVersion();if(t<e)throw new Error(`adb server version (${t}) doesn't match this client (${e})`)}async killServer(){const e=await this.createConnection("host:kill");await e.dispose()}async getServerFeatures(){const e=await this.createConnection("host:host-features");try{return(await e.readString()).split(",")}finally{await e.dispose()}}async getDevices(e=["device","unauthorized"]){const t=await this.createConnection("host:devices-l");try{const r=await t.readString();return pr.parseDeviceList(r,e)}finally{await t.dispose()}}async trackDevices(e){return this.#ge.createObserver(e)}async reconnectDevice(e){const t=await this.createConnection("offline"===e?"host:reconnect-offline":pr.formatDeviceService(e,"reconnect"));try{await t.readString()}finally{await t.dispose()}}async getDeviceFeatures(e){const t=await this.createDeviceConnection(e,"host:features"),r=new ir(t);try{const e=(await r.readString()).split(",");return{transportId:t.transportId,features:e}}finally{await r.dispose()}}async createDeviceConnection(e,t){let r,s;if(e)if("transportId"in e)r=`host:transport-id:${e.transportId}`,s=e.transportId;else if("serial"in e)await this.validateVersion(41),r=`host:tport:serial:${e.serial}`;else if("usb"in e)await this.validateVersion(41),r="host:tport:usb";else{if(!("tcp"in e))throw new TypeError("Invalid device selector");await this.validateVersion(41),r="host:tport:local"}else await this.validateVersion(41),r="host:tport:any";const i=await this.createConnection(r);try{await i.writeString(t)}catch(e){throw await i.dispose(),e}try{if(void 0===s){const e=await i.readExactly(8);s=N(e,0)}await i.readOkay();const e=i.release();return{transportId:s,service:t,readable:e.readable,writable:e.writable,get closed(){return e.closed},async close(){await e.close()}}}catch(e){throw await i.dispose(),e}}async#be(e,t,r){let s;if(e)if("transportId"in e)s="any";else if("serial"in e)s="any";else if("usb"in e)s="usb";else{if(!("tcp"in e))throw new TypeError("Invalid device selector");s="local"}else s="any";const i=pr.formatDeviceService(e,`wait-for-${s}-${t}`),n=await this.createConnection(i,r);try{await n.readOkay()}finally{await n.dispose()}}async waitFor(e,t,r){return"disconnect"===t&&await this.validateVersion(41),this.#be(e,t,r)}async waitForDisconnect(e,t){if(await this.getVersion()>=41)return this.#be({transportId:e},"disconnect",t);{const r=await this.trackDevices(t);return new Promise(((t,s)=>{r.onDeviceRemove((s=>{s.some((t=>t.transportId===e))&&(r.stop(),t())})),r.onError((e=>{r.stop(),s(e)}))}))}}async createTransport(e){const{transportId:t,features:r}=await this.getDeviceFeatures(e),s=(await this.getDevices()).find((e=>e.transportId===t)),i=new kt(s?.product,s?.model,s?.device,r),n=new l,a=this.waitForDisconnect(t,{unref:!0,signal:n.signal}),o=new wr(this,s?.serial??"",i,t,a);return o.disconnected.finally((()=>n.abort())),o}async createAdb(e){const t=await this.createTransport(e);return new mt(t)}}async function fr(e,...t){const r=new O;function s(){r.reject(this.reason)}try{for(const e of t)if(e){if(e.aborted)throw e.reason;e.addEventListener("abort",s)}return await Promise.race([e(),r.promise])}finally{for(const e of t)e&&e.removeEventListener("abort",s)}}export{Jt as ADB_DAEMON_DEFAULT_FEATURES,Qt as ADB_DAEMON_DEFAULT_INITIAL_PAYLOAD_SIZE,Zt as ADB_DAEMON_VERSION_OMIT_CHECKSUM,Kt as ADB_DEFAULT_AUTHENTICATORS,ur as ADB_SERVER_DEFAULT_FEATURES,nt as ADB_SYNC_MAX_PACKET_SIZE,Ot as ASN1_NULL,zt as ASN1_OCTET_STRING,Rt as ASN1_OID,_t as ASN1_SEQUENCE,mt as Adb,Mt as AdbAuthType,Yt as AdbAuthenticationProcessor,kt as AdbBanner,vt as AdbBannerKey,Vt as AdbCommand,Gt as AdbDaemonSocket,Ht as AdbDaemonSocketController,er as AdbDaemonTransport,Ce as AdbFeature,Y as AdbFrameBufferError,G as AdbFrameBufferForbiddenError,H as AdbFrameBufferUnsupportedVersionError,j as AdbFrameBufferV1,K as AdbFrameBufferV2,ke as AdbNoneProtocolProcessImpl,Se as AdbNoneProtocolPtyProcess,Ae as AdbNoneProtocolSpawner,Te as AdbNoneProtocolSubprocessService,Bt as AdbPacket,Xt as AdbPacketDispatcher,Ft as AdbPacketHeader,Nt as AdbPacketSerializeStream,Z as AdbPower,jt as AdbPublicKeyAuthenticator,ye as AdbReverseError,ge as AdbReverseNotSupportedError,ve as AdbReverseService,pr as AdbServerClient,hr as AdbServerDeviceObserverOwner,ir as AdbServerStream,wr as AdbServerTransport,M as AdbServiceBase,Ie as AdbShellProtocolId,De as AdbShellProtocolPacket,Pe as AdbShellProtocolProcessImpl,Le as AdbShellProtocolPtyProcess,_e as AdbShellProtocolSpawner,ze as AdbShellProtocolSubprocessService,qt as AdbSignatureAuthenticator,Oe as AdbSubprocessService,yt as AdbSync,rt as AdbSyncDataResponse,Je as AdbSyncEntry2Response,Ze as AdbSyncEntryResponse,$e as AdbSyncError,Ve as AdbSyncFailResponse,je as AdbSyncLstatResponse,Ne as AdbSyncNumberRequest,at as AdbSyncOkResponse,Ue as AdbSyncRequestId,We as AdbSyncResponseId,lt as AdbSyncSendV2Flags,dt as AdbSyncSendV2Request,pt as AdbSyncSocket,wt as AdbSyncSocketLocked,Ke as AdbSyncStatErrorCode,He as AdbSyncStatResponse,bt as AdbTcpIpService,J as AutoResetEvent,sr as FAIL,qe as LinuxFileType,le as NOOP,we as Ref,Wt as SHA1_DIGEST_INFO,Lt as SHA1_DIGEST_LENGTH,Dt as adbGeneratePublicKey,It as adbGetPublicKeySize,Re as adbSyncEncodeId,Ge as adbSyncLstat,tt as adbSyncOpenDir,et as adbSyncOpenDirV1,Qe as adbSyncOpenDirV2,it as adbSyncPull,st as adbSyncPullGenerator,ut as adbSyncPush,ct as adbSyncPushV1,ht as adbSyncPushV2,Fe as adbSyncReadResponse,Be as adbSyncReadResponses,Xe as adbSyncStat,Me as adbSyncWriteRequest,re as calculateBase64EncodedLength,Ut as calculateChecksum,ne as decodeBase64,ft as dirname,se as encodeBase64,Ee as escapeArg,X as framebuffer,St as getBigUint,oe as hexToNumber,Tt as modInverse,Pt as powMod,fr as raceSignal,xt as rsaParsePrivateKey,$t as rsaSign,pe as sequenceEqual,Et as setBigUint,xe as splitCommand,lr as unorderedRemove,de as unreachable,ce as write4HexDigits};export default null;
//# sourceMappingURL=/sm/9372ed882a27822ba0e63b20d6d043ad3d2bbd061847856b2353ccb1b5fd4ab4.map
